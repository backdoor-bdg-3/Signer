{% extends "base.html" %}

{% block title %}App Entitlements - Backdoor Web Signer{% endblock %}

{% block extra_head %}
<style>
    .entitlements-page {
        padding: var(--spacing-lg);
    }
    
    .entitlements-header {
        margin-bottom: var(--spacing-lg);
        text-align: center;
    }
    
    .entitlements-header h2 {
        color: var(--primary-light);
        margin-bottom: var(--spacing-sm);
    }
    
    .entitlements-header p {
        color: var(--text-secondary);
        max-width: 800px;
        margin: 0 auto;
    }
    
    .entitlements-container {
        background-color: var(--dark-surface);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-lg);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }
    
    .entitlements-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--spacing-lg);
    }
    
    .entitlements-card {
        background-color: var(--dark-surface-2);
        border-radius: var(--border-radius-md);
        padding: var(--spacing-md);
        position: relative;
        overflow: hidden;
        margin-bottom: var(--spacing-md);
    }
    
    .entitlements-card h3 {
        color: var(--secondary-color);
        margin-bottom: var(--spacing-md);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }
    
    .entitlements-card h3 i {
        font-size: 1.2rem;
    }
    
    .loading-spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--text-primary);
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
    
    .entitlements-empty {
        text-align: center;
        padding: var(--spacing-xl);
        color: var(--text-secondary);
    }
    
    .entitlements-empty i {
        font-size: 3rem;
        margin-bottom: var(--spacing-md);
        color: var(--primary-light);
        opacity: 0.5;
    }
    
    .entitlements-empty p {
        margin-bottom: var(--spacing-md);
    }
    
    .glow-effect {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at center, var(--neon-purple) 0%, transparent 70%);
        opacity: 0.1;
        pointer-events: none;
    }
    
    .entitlements-actions {
        display: flex;
        justify-content: center;
        gap: var(--spacing-md);
        margin-top: var(--spacing-lg);
    }
    
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        font-weight: 500;
        border-radius: var(--border-radius-md);
        cursor: pointer;
        transition: var(--transition-normal);
        text-decoration: none;
        border: none;
        outline: none;
        position: relative;
        overflow: hidden;
        gap: 0.5rem;
        min-width: 120px;
    }
    
    .entitlements-category {
        margin-bottom: var(--spacing-md);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: var(--spacing-sm);
    }
    
    .entitlements-category h4 {
        color: var(--primary-light);
        margin-bottom: var(--spacing-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }
    
    .entitlement-item {
        display: flex;
        margin-bottom: var(--spacing-sm);
        padding: var(--spacing-sm);
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: var(--border-radius-sm);
        align-items: center;
    }
    
    .entitlement-item:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
    
    .entitlement-checkbox {
        margin-right: var(--spacing-sm);
    }
    
    .entitlement-info {
        flex-grow: 1;
    }
    
    .entitlement-name {
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }
    
    .entitlement-name .app-badge {
        background-color: var(--primary-color);
        color: white;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: var(--spacing-sm);
    }
    
    .entitlement-name .provision-badge {
        background-color: var(--secondary-color);
        color: white;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: var(--spacing-sm);
    }
    
    .entitlement-description {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-top: 4px;
    }
    
    .entitlement-value {
        font-family: monospace;
        background-color: rgba(0, 0, 0, 0.3);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        margin-top: 4px;
        word-break: break-all;
        color: var(--text-tertiary);
    }
    
    .entitlements-summary {
        background-color: var(--dark-surface-3);
        border-radius: var(--border-radius-md);
        padding: var(--spacing-md);
        margin-top: var(--spacing-md);
    }
    
    .entitlements-summary h4 {
        color: var(--primary-light);
        margin-bottom: var(--spacing-sm);
    }
    
    .entitlements-summary p {
        color: var(--text-secondary);
        margin-bottom: var(--spacing-sm);
    }
    
    .entitlements-warning {
        background-color: rgba(255, 171, 0, 0.1);
        border-left: 3px solid var(--warning-color);
        padding: var(--spacing-md);
        margin-top: var(--spacing-lg);
        border-radius: var(--border-radius-sm);
    }
    
    .entitlements-warning h4 {
        color: var(--warning-color);
        margin-bottom: var(--spacing-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }
    
    .provision-section {
        margin-bottom: var(--spacing-md);
    }
    
    .provision-section h4 {
        color: var(--secondary-color);
        margin-bottom: var(--spacing-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }
    
    .info-icon {
        color: var(--text-tertiary);
        font-size: 0.9rem;
        cursor: help;
        margin-left: 4px;
    }
    
    .tooltip {
        position: relative;
        display: inline-block;
    }
    
    .tooltip .tooltip-text {
        visibility: hidden;
        width: 200px;
        background-color: var(--dark-surface);
        color: var(--text-primary);
        text-align: center;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.8rem;
        font-weight: normal;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        pointer-events: none;
    }
    
    .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<section class="entitlements-page">
    <div class="entitlements-header">
        <h2>App Entitlements Manager</h2>
        <p>Review and customize the entitlements for your iOS application. Entitlements determine what system resources and capabilities your app can use.</p>
    </div>
    
    <div class="entitlements-container">
        <div id="loading-container" style="display: none;">
            <div class="loading-spinner"></div>
            <p class="text-center">Extracting entitlements from your files...</p>
        </div>
        
        <div id="entitlements-content">
            <div class="entitlements-empty">
                <i class="fas fa-file-code"></i>
                <p>Upload your IPA and provisioning profile to view entitlements</p>
                <form id="entitlements-upload-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <div class="file-upload">
                            <label for="ipa_file" class="file-label">
                                <i class="fas fa-file-archive"></i>
                                <span class="file-text">Choose IPA File</span>
                            </label>
                            <input type="file" id="ipa_file" name="ipa_file" class="file-input" accept=".ipa">
                            <div class="file-name" id="ipa-file-name">No file chosen</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="file-upload">
                            <label for="provision_file" class="file-label">
                                <i class="fas fa-file-signature"></i>
                                <span class="file-text">Choose Mobile Provision</span>
                            </label>
                            <input type="file" id="provision_file" name="provision_file" class="file-input" accept=".mobileprovision">
                            <div class="file-name" id="provision-file-name">No file chosen</div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Extract Entitlements
                    </button>
                </form>
            </div>
        </div>
        
        <div id="provision-info" class="entitlements-card" style="display: none; margin-bottom: var(--spacing-lg);">
            <div class="glow-effect"></div>
            <h3><i class="fas fa-id-card"></i> Provisioning Profile Information</h3>
            <div id="provision-info-content"></div>
        </div>
        
        <div id="entitlements-results" style="display: none;">
            <div class="entitlements-card">
                <div class="glow-effect"></div>
                <h3><i class="fas fa-puzzle-piece"></i> App Entitlements</h3>
                <p class="mb-3">Select the entitlements you want to include in your signed app. Entitlements marked with <span class="app-badge">App</span> are requested by your app, while those with <span class="provision-badge">Provision</span> are available in your provisioning profile.</p>
                
                <div id="entitlements-categories-container"></div>
                
                <div class="entitlements-warning">
                    <h4><i class="fas fa-exclamation-triangle"></i> Important Note</h4>
                    <p>It's recommended to only include entitlements that your app actually requires. Including unnecessary entitlements may not affect functionality but it's always safer to only use the specific entitlements your app needs.</p>
                </div>
            </div>
            
            <div class="entitlements-card">
                <div class="glow-effect"></div>
                <h3><i class="fas fa-check-square"></i> Selected Entitlements Summary</h3>
                <div id="selected-entitlements-summary"></div>
            </div>
        </div>
    </div>
    
    <div class="entitlements-actions" id="entitlements-actions" style="display: none;">
        <button id="apply-entitlements-btn" class="btn btn-primary">
            <i class="fas fa-check"></i> Apply Selected Entitlements
        </button>
        <a href="{{ url_for('main.advanced') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Advanced Signing
        </a>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const entitlementsUploadForm = document.getElementById('entitlements-upload-form');
        const loadingContainer = document.getElementById('loading-container');
        const entitlementsContent = document.getElementById('entitlements-content');
        const entitlementsResults = document.getElementById('entitlements-results');
        const entitlementsActions = document.getElementById('entitlements-actions');
        const categoriesContainer = document.getElementById('entitlements-categories-container');
        const selectedSummary = document.getElementById('selected-entitlements-summary');
        const applyEntitlementsBtn = document.getElementById('apply-entitlements-btn');
        const provisionInfoSection = document.getElementById('provision-info');
        const provisionInfoContent = document.getElementById('provision-info-content');
        
        // Entitlement descriptions
        const entitlementDescriptions = {
            // App capability entitlements
            'com.apple.developer.associated-domains': 'Allows your app to securely connect with associated websites and handle universal links.',
            'com.apple.developer.authentication-services.autofill-credential-provider': 'Enables your app to provide login credentials for AutoFill in Safari and apps.',
            'com.apple.developer.ClassKit-environment': 'Allows educational apps to share student progress with teachers through the Schoolwork app.',
            'com.apple.developer.fileprovider.testing-mode': 'Enables testing mode for file provider extensions.',
            'com.apple.developer.game-center': 'Integrates your app with Game Center for leaderboards, achievements, and multiplayer features.',
            'com.apple.developer.homekit': 'Enables communication with HomeKit-compatible smart home devices.',
            'com.apple.developer.icloud-container-identifiers': 'Defines specific containers for iCloud storage.',
            'com.apple.developer.icloud-services': 'Enables iCloud capabilities like CloudKit and iCloud Drive.',
            'com.apple.developer.networking.wifi-info': 'Allows access to the device's Wi-Fi network information.',
            'com.apple.developer.healthkit': 'Enables access to HealthKit data with user permission.',
            'com.apple.developer.payment-pass-provisioning': 'Allows provisioning of payment passes.',
            'com.apple.developer.in-app-payments': 'Enables Apple Pay for in-app purchases.',
            'com.apple.developer.networking.HotspotConfiguration': 'Allows configuration of Wi-Fi hotspots.',
            'com.apple.developer.networking.multipath': 'Enables the use of multiple network paths simultaneously.',
            'com.apple.developer.networking.networkextension': 'Enables VPN, content filtering, and DNS proxy capabilities.',
            'com.apple.developer.nfc.readersession.formats': 'Allows the app to read NFC tags.',
            'aps-environment': 'Required for Apple Push Notification service.',
            'com.apple.developer.push-to-talk': 'Enables push-to-talk communication features.',
            'application-identifier': 'Unique identifier for your app in the Apple ecosystem.',
            'com.apple.developer.team-identifier': 'Your Apple Developer team identifier.',
            'com.apple.security.application-groups': 'Allows data sharing between apps from the same developer.',
            'keychain-access-groups': 'Defines which keychain access groups your app can access.',
            
            // General
            'get-task-allow': 'Enables debugging capabilities (usually false for distribution builds).',
            'com.apple.developer.default-data-protection': 'Sets default data protection level for app data.',
            'inter-app-audio': 'Enables Inter-App Audio (deprecated in favor of Audio Units).',
            
            // New frameworks
            'com.apple.developer.usernotifications.communication': 'Enables communication notifications features.',
            'com.apple.developer.usernotifications.time-sensitive': 'Allows time-sensitive notifications.',
            'com.apple.developer.group-session': 'Enables SharePlay and group activities.',
            'com.apple.developer.applesignin': 'Enables Sign in with Apple functionality.',
            'com.apple.developer.family-controls': 'Enables family controls and screen time features.',
            'com.apple.developer.user-fonts': 'Allows installing custom fonts.',
            
            // Advanced capabilities
            'com.apple.developer.healthkit.background-delivery': 'Enables background delivery of HealthKit data.',
            'com.apple.developer.networking.vpn.api': 'Allows creating custom VPN solutions.',
            'com.apple.developer.siri': 'Integrates your app with Siri.',
            'com.apple.developer.coremedia.hls.low-latency': 'Enables low-latency streaming.',
            'com.apple.developer.devicecheck.appattest-environment': 'Enables App Attest to verify the authenticity of your app.',
            'com.apple.developer.maps': 'Enables advanced Apple Maps features.'
        };
        
        // Entitlement categories
        const entitlementCategories = {
            'Networking': [
                'com.apple.developer.networking.wifi-info',
                'com.apple.developer.networking.HotspotConfiguration',
                'com.apple.developer.networking.multipath',
                'com.apple.developer.networking.networkextension',
                'com.apple.developer.networking.vpn.api',
                'com.apple.developer.networking.slicing.appcategory',
                'com.apple.developer.networking.slicing.trafficcategory'
            ],
            'App Services': [
                'com.apple.developer.associated-domains',
                'com.apple.developer.associated-domains.mdm-managed',
                'aps-environment',
                'com.apple.developer.usernotifications.communication',
                'com.apple.developer.usernotifications.time-sensitive',
                'com.apple.developer.game-center',
                'com.apple.developer.siri',
                'com.apple.developer.applesignin'
            ],
            'Apple Pay and Wallet': [
                'com.apple.developer.in-app-payments',
                'com.apple.developer.payment-pass-provisioning',
                'com.apple.developer.pay-later-merchandising'
            ],
            'iCloud': [
                'com.apple.developer.icloud-container-identifiers',
                'com.apple.developer.icloud-container-development-container-identifiers',
                'com.apple.developer.icloud-services',
                'com.apple.developer.ubiquity-container-identifiers',
                'com.apple.developer.ubiquity-kvstore-identifier'
            ],
            'Health and Fitness': [
                'com.apple.developer.healthkit',
                'com.apple.developer.healthkit.access',
                'com.apple.developer.healthkit.background-delivery',
                'com.apple.developer.healthkit.recalibrate-estimates'
            ],
            'Hardware and Peripherals': [
                'com.apple.developer.nfc.readersession.formats',
                'com.apple.developer.matter.allow-setup-payload'
            ],
            'Media and Apple Music': [
                'inter-app-audio',
                'com.apple.developer.coremedia.hls.low-latency',
                'com.apple.developer.media-device-discovery-extension',
                'com.apple.developer.calling-app',
                'com.apple.developer.push-to-talk'
            ],
            'App Capabilities': [
                'com.apple.developer.ClassKit-environment',
                'com.apple.developer.fileprovider.testing-mode',
                'com.apple.developer.user-fonts',
                'com.apple.developer.homekit',
                'com.apple.developer.accessibility.merchant-api-control',
                'com.apple.developer.authentication-services.autofill-credential-provider',
                'com.apple.developer.group-session',
                'com.apple.developer.shared-with-you.collaboration',
                'com.apple.developer.family-controls',
                'com.apple.developer.journal.allow'
            ],
            'App Groups and Data Sharing': [
                'com.apple.security.application-groups',
                'keychain-access-groups'
            ],
            'Security and Authentication': [
                'get-task-allow',
                'com.apple.developer.default-data-protection',
                'com.apple.developer.devicecheck.appattest-environment',
                'com.apple.developer.proximity-reader.identity.display',
                'com.apple.developer.managed-app-distribution.install-ui'
            ],
            'Identifiers': [
                'application-identifier',
                'com.apple.developer.team-identifier'
            ]
        };
        
        // File input display
        const fileInputs = {
            'ipa_file': 'ipa-file-name',
            'provision_file': 'provision-file-name'
        };
        
        for (const [inputId, displayId] of Object.entries(fileInputs)) {
            const input = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            
            if (input && display) {
                input.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        display.textContent = this.files[0].name;
                        display.classList.add('has-file');
                    } else {
                        display.textContent = 'No file chosen';
                        display.classList.remove('has-file');
                    }
                });
            }
        }
        
        // Extract entitlements form submission
        if (entitlementsUploadForm) {
            entitlementsUploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const ipaFile = document.getElementById('ipa_file').files[0];
                const provisionFile = document.getElementById('provision_file').files[0];
                
                if (!ipaFile || !provisionFile) {
                    alert('Please select both an IPA file and a provisioning profile.');
                    return;
                }
                
                // Show loading spinner
                entitlementsContent.style.display = 'none';
                loadingContainer.style.display = 'block';
                
                const formData = new FormData();
                formData.append('ipa_file', ipaFile);
                formData.append('provision_file', provisionFile);
                
                // Send request to extract entitlements
                fetch('/extract-entitlements', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Hide loading spinner
                    loadingContainer.style.display = 'none';
                    
                    if (data.error) {
                        entitlementsContent.innerHTML = `<div class="error-message">${data.error}</div>`;
                        entitlementsContent.style.display = 'block';
                        return;
                    }
                    
                    // Display entitlements
                    const allEntitlements = data.all_entitlements || {};
                    const appEntitlements = data.app_entitlements || {};
                    const provisionEntitlements = data.provision_entitlements || {};
                    const provisionInfo = data.provision_info || {};
                    
                    if (Object.keys(allEntitlements).length === 0) {
                        entitlementsContent.innerHTML = '<div class="entitlements-empty"><i class="fas fa-exclamation-circle"></i><p>No entitlements found in the IPA or provisioning profile.</p></div>';
                        entitlementsContent.style.display = 'block';
                        return;
                    }
                    
                    // Show entitlements results
                    entitlementsResults.style.display = 'block';
                    entitlementsActions.style.display = 'flex';
                    
                    // Display provision info if available
                    if (provisionInfo && Object.keys(provisionInfo).length > 0) {
                        provisionInfoSection.style.display = 'block';
                        provisionInfoContent.innerHTML = createProvisionInfoTable(provisionInfo);
                    }
                    
                    // Organize entitlements by category and render them
                    renderEntitlementsByCategory(allEntitlements, appEntitlements, provisionEntitlements);
                    
                    // Update summary of selected entitlements
                    updateEntitlementsSummary();
                })
                .catch(error => {
                    loadingContainer.style.display = 'none';
                    entitlementsContent.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
                    entitlementsContent.style.display = 'block';
                });
            });
        }
        
        // Apply selected entitlements
        if (applyEntitlementsBtn) {
            applyEntitlementsBtn.addEventListener('click', function() {
                const selectedEntitlements = {};
                const checkboxes = document.querySelectorAll('.entitlement-checkbox:checked');
                
                checkboxes.forEach(checkbox => {
                    const key = checkbox.dataset.key;
                    const value = JSON.parse(checkbox.dataset.value);
                    selectedEntitlements[key] = value;
                });
                
                // Create plist XML from selected entitlements
                const plistXml = createPlistXml(selectedEntitlements);
                
                // Store in session storage to pass back to the advanced page
                sessionStorage.setItem('selectedEntitlements', plistXml);
                
                // Redirect back to advanced signing page
                window.location.href = "{{ url_for('main.advanced') }}";
            });
        }
        
        // Helper function to create provision info table
        function createProvisionInfoTable(provisionInfo) {
            let html = '<div class="provision-details">';
            
            if (provisionInfo.profile_name) {
                html += `<p><strong>Profile Name:</strong> ${provisionInfo.profile_name}</p>`;
            }
            
            if (provisionInfo.team_name) {
                html += `<p><strong>Team Name:</strong> ${provisionInfo.team_name}</p>`;
            }
            
            if (provisionInfo.creation_date) {
                const date = new Date(provisionInfo.creation_date);
                html += `<p><strong>Creation Date:</strong> ${date.toLocaleDateString()}</p>`;
            }
            
            if (provisionInfo.udids && provisionInfo.udids.length > 0) {
                html += `<p><strong>Provisioned Devices:</strong> ${provisionInfo.udids.length} device(s)</p>`;
                html += '<div class="udids-list" style="max-height: 150px; overflow-y: auto; margin-top: 8px;">';
                html += '<ul style="padding-left: 20px; margin: 0;">';
                
                provisionInfo.udids.forEach(udid => {
                    html += `<li style="margin-bottom: 4px; font-family: monospace; font-size: 0.8rem;">${udid}</li>`;
                });
                
                html += '</ul>';
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }
        
        // Render entitlements organized by category
        function renderEntitlementsByCategory(allEntitlements, appEntitlements, provisionEntitlements) {
            categoriesContainer.innerHTML = '';
            
            // Get all unique entitlement keys
            const allKeys = Object.keys(allEntitlements);
            
            // Get categories with entitlements
            const categoriesWithEntitlements = {};
            
            // First place entitlements into their categories
            allKeys.forEach(key => {
                let found = false;
                
                // Check each category
                for (const [category, entitlements] of Object.entries(entitlementCategories)) {
                    if (entitlements.includes(key)) {
                        if (!categoriesWithEntitlements[category]) {
                            categoriesWithEntitlements[category] = [];
                        }
                        categoriesWithEntitlements[category].push(key);
                        found = true;
                        break;
                    }
                }
                
                // If not found in any category, add to Other
                if (!found) {
                    if (!categoriesWithEntitlements['Other']) {
                        categoriesWithEntitlements['Other'] = [];
                    }
                    categoriesWithEntitlements['Other'].push(key);
                }
            });
            
            // Render each category
            for (const [category, entitlementKeys] of Object.entries(categoriesWithEntitlements)) {
                if (entitlementKeys.length === 0) continue;
                
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'entitlements-category';
                
                // Category header
                let categoryIcon = '';
                switch (category) {
                    case 'Networking': categoryIcon = 'fas fa-network-wired'; break;
                    case 'App Services': categoryIcon = 'fas fa-cogs'; break;
                    case 'Apple Pay and Wallet': categoryIcon = 'fab fa-apple-pay'; break;
                    case 'iCloud': categoryIcon = 'fas fa-cloud'; break;
                    case 'Health and Fitness': categoryIcon = 'fas fa-heartbeat'; break;
                    case 'Hardware and Peripherals': categoryIcon = 'fas fa-microchip'; break;
                    case 'Media and Apple Music': categoryIcon = 'fas fa-music'; break;
                    case 'App Capabilities': categoryIcon = 'fas fa-puzzle-piece'; break;
                    case 'App Groups and Data Sharing': categoryIcon = 'fas fa-share-alt'; break;
                    case 'Security and Authentication': categoryIcon = 'fas fa-shield-alt'; break;
                    case 'Identifiers': categoryIcon = 'fas fa-id-badge'; break;
                    default: categoryIcon = 'fas fa-cubes';
                }
                
                categoryDiv.innerHTML = `<h4><i class="${categoryIcon}"></i> ${category}</h4>`;
                
                // Sort entitlements alphabetically within category
                entitlementKeys.sort();
                
                // For each entitlement in this category
                entitlementKeys.forEach(key => {
                    const value = allEntitlements[key];
                    const inApp = key in appEntitlements;
                    const inProvision = key in provisionEntitlements;
                    
                    // Create entitlement item element
                    const entitlementEl = createEntitlementElement(key, value, inApp, inProvision);
                    categoryDiv.appendChild(entitlementEl);
                });
                
                categoriesContainer.appendChild(categoryDiv);
            }
            
            // Add event listeners to checkboxes
            const checkboxes = document.querySelectorAll('.entitlement-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateEntitlementsSummary);
            });
        }
        
        // Create a single entitlement element
        function createEntitlementElement(key, value, inApp, inProvision) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'entitlement-item';
            
            // Format the value for display
            const valueStr = JSON.stringify(value);
            let valueDisplay = formatEntitlementValue(value);
            
            // Get description or default
            const description = entitlementDescriptions[key] || 'This entitlement configures app capabilities.';
            
            // Create the HTML structure
            itemDiv.innerHTML = `
                <input type="checkbox" class="entitlement-checkbox" id="entitlement-${key.replace(/\./g, '-')}" 
                       data-key="${key}" data-value='${valueStr}' ${inApp ? 'checked' : ''}>
                <div class="entitlement-info">
                    <div class="entitlement-name">
                        ${key}
                        ${inApp ? '<span class="app-badge">App</span>' : ''}
                        ${inProvision ? '<span class="provision-badge">Provision</span>' : ''}
                        <div class="tooltip">
                            <i class="fas fa-info-circle info-icon"></i>
                            <span class="tooltip-text">${description}</span>
                        </div>
                    </div>
                    <div class="entitlement-description">${description}</div>
                    <div class="entitlement-value">${valueDisplay}</div>
                </div>
            `;
            
            return itemDiv;
        }
        
        // Format entitlement value for display
        function formatEntitlementValue(value) {
            if (typeof value === 'boolean') {
                return value ? '<span style="color: #4CAF50;">true</span>' : '<span style="color: #F44336;">false</span>';
            } else if (Array.isArray(value)) {
                if (value.length === 0) return '[]';
                return JSON.stringify(value, null, 2)
                    .replace(/\n/g, '<br>')
                    .replace(/ /g, '&nbsp;');
            } else if (typeof value === 'object' && value !== null) {
                return JSON.stringify(value, null, 2)
                    .replace(/\n/g, '<br>')
                    .replace(/ /g, '&nbsp;');
            } else {
                return String(value);
            }
        }
        
        // Update entitlements summary
        function updateEntitlementsSummary() {
            const selectedEntitlements = {};
            const checkboxes = document.querySelectorAll('.entitlement-checkbox:checked');
            
            checkboxes.forEach(checkbox => {
                const key = checkbox.dataset.key;
                const value = JSON.parse(checkbox.dataset.value);
                selectedEntitlements[key] = value;
            });
            
            // Create summary HTML
            let summaryHtml = '';
            
            if (checkboxes.length === 0) {
                summaryHtml = '<p>No entitlements selected. Your app will be signed without any entitlements.</p>';
            } else {
                summaryHtml = `
                    <p>You have selected ${checkboxes.length} entitlement(s) for your app:</p>
                    <ul class="selected-entitlements-list">
                `;
                
                checkboxes.forEach(checkbox => {
                    const key = checkbox.dataset.key;
                    summaryHtml += `<li>${key}</li>`;
                });
                
                summaryHtml += '</ul>';
            }
            
            // Add the entitlements XML preview
            if (checkboxes.length > 0) {
                const plistXml = createPlistXml(selectedEntitlements);
                const previewXml = plistXml.substring(0, 200) + (plistXml.length > 200 ? '...' : '');
                
                summaryHtml += `
                    <div class="entitlements-xml-preview">
                        <h4>Entitlements XML Preview:</h4>
                        <pre style="max-height: 100px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; font-size: 0.8rem;">${previewXml}</pre>
                    </div>
                `;
            }
            
            selectedSummary.innerHTML = summaryHtml;
        }
        
        // Create plist XML from selected entitlements
        function createPlistXml(entitlements) {
            let plistXml = '<?xml version="1.0" encoding="UTF-8"?>\n';
            plistXml += '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n';
            plistXml += '<plist version="1.0">\n';
            plistXml += '<dict>\n';
            
            for (const [key, value] of Object.entries(entitlements)) {
                plistXml += `    <key>${key}</key>\n`;
                plistXml += formatPlistValue(value, 1);
            }
            
            plistXml += '</dict>\n';
            plistXml += '</plist>';
            
            return plistXml;
        }
        
        // Format value for plist XML
        function formatPlistValue(value, indent) {
            const indentStr = '    '.repeat(indent);
            
            if (typeof value === 'boolean') {
                return `${indentStr}<${value ? 'true' : 'false'}/>\n`;
            } else if (typeof value === 'string') {
                return `${indentStr}<string>${value}</string>\n`;
            } else if (typeof value === 'number') {
                if (Number.isInteger(value)) {
                    return `${indentStr}<integer>${value}</integer>\n`;
                } else {
                    return `${indentStr}<real>${value}</real>\n`;
                }
            } else if (Array.isArray(value)) {
                let result = `${indentStr}<array>\n`;
                for (const item of value) {
                    result += formatPlistValue(item, indent + 1);
                }
                result += `${indentStr}</array>\n`;
                return result;
            } else if (typeof value === 'object' && value !== null) {
                let result = `${indentStr}<dict>\n`;
                for (const [k, v] of Object.entries(value)) {
                    result += `${indentStr}    <key>${k}</key>\n`;
                    result += formatPlistValue(v, indent + 1);
                }
                result += `${indentStr}</dict>\n`;
                return result;
            } else {
                return `${indentStr}<string>${value}</string>\n`;
            }
        }
    });
</script>
{% endblock %}
                        <td class="key-column">${key}</td>
                        <td class="value-column">
                            <span class="entitlements-value" id="${elementId}" data-value='${valueStr}'>${valueDisplay}</span>
                        </td>
                        <td class="select-column">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" class="custom-checkbox entitlement-checkbox" 
                                       id="${type}-checkbox-${key.replace(/\./g, '-')}" 
                                       data-key="${key}" 
                                       data-type="${type}" 
                                       checked>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            return html;
        }
        
        // Helper function to format entitlement values for display
        function createProvisionInfoTable(provisionInfo) {
            let html = '<div class="provision-info-container">';
            
            // Profile information
            html += `
                <div class="provision-section">
                    <h4><i class="fas fa-info-circle"></i> Profile Details</h4>
                    <table class="entitlements-table">
                        <tbody>
                            <tr>
                                <td class="key-column">Profile Name</td>
                                <td class="value-column"><span class="entitlements-value">${provisionInfo.profile_name || 'N/A'}</span></td>
                            </tr>
                            <tr>
                                <td class="key-column">Team Name</td>
                                <td class="value-column"><span class="entitlements-value">${provisionInfo.team_name || 'N/A'}</span></td>
                            </tr>
                            <tr>
                                <td class="key-column">App ID Name</td>
                                <td class="value-column"><span class="entitlements-value">${provisionInfo.app_id_name || 'N/A'}</span></td>
                            </tr>
                            <tr>
                                <td class="key-column">Creation Date</td>
                                <td class="value-column"><span class="entitlements-value">${provisionInfo.creation_date ? new Date(provisionInfo.creation_date).toLocaleString() : 'N/A'}</span></td>
                            </tr>
                            <tr>
                                <td class="key-column">Expiration Date</td>
                                <td class="value-column"><span class="entitlements-value">${provisionInfo.expiration_date ? new Date(provisionInfo.expiration_date).toLocaleString() : 'N/A'}</span></td>
                            </tr>
                            <tr>
                                <td class="key-column">Developer Profile</td>
                                <td class="value-column"><span class="entitlements-value">${provisionInfo.is_developer_profile ? 'Yes' : 'No'}</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            // UDIDs section
            const udids = provisionInfo.udids || [];
            if (udids.length > 0) {
                html += `
                    <div class="provision-section" style="margin-top: 20px;">
                        <h4><i class="fas fa-mobile-alt"></i> Provisioned Devices (${udids.length})</h4>
                        <div class="udids-container" style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                            <table class="entitlements-table">
                                <thead>
                                    <tr>
                                        <th>Device UDID</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                udids.forEach(udid => {
                    html += `
                        <tr>
                            <td><span class="entitlements-value">${udid}</span></td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Add warning for developer profiles with UDIDs
                if (provisionInfo.is_developer_profile) {
                    html += `
                        <div class="entitlements-warning" style="margin-top: 20px;">
                            <h4><i class="fas fa-exclamation-triangle"></i> Developer Profile with Device Restrictions</h4>
                            <p>This is an Apple Developer profile with specific device UDIDs. The app will only work on the devices listed above. 
                            The signer will use the force flag (-f) to ensure proper signing with UDID restrictions.</p>
                        </div>
                    `;
                }
            } else {
                html += `
                    <div class="provision-section" style="margin-top: 20px;">
                        <h4><i class="fas fa-mobile-alt"></i> Provisioned Devices</h4>
                        <p>No specific device restrictions. This app can be installed on any device.</p>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        function formatEntitlementValue(value) {
            if (typeof value === 'boolean') {
                return value ? 'true' : 'false';
            } else if (Array.isArray(value)) {
                if (value.length === 0) {
                    return '[]';
                } else if (value.length === 1) {
                    return `[${formatEntitlementValue(value[0])}]`;
                } else {
                    return `[${value.length} items]`;
                }
            } else if (typeof value === 'object' && value !== null) {
                return '{...}';
            } else {
                return String(value);
            }
        }
        
        // Update selected entitlements table
        function updateSelectedEntitlements() {
            const selectedEntitlements = {};
            const checkboxes = document.querySelectorAll('.entitlement-checkbox:checked');
            
            checkboxes.forEach(checkbox => {
                const key = checkbox.dataset.key;
                const type = checkbox.dataset.type;
                const valueElement = document.querySelector(`#${type}-value-${key.replace(/\./g, '-')}`);
                
                if (valueElement) {
                    const value = JSON.parse(valueElement.dataset.value);
                    selectedEntitlements[key] = {
                        value: value,
                        type: type
                    };
                }
            });
            
            // Populate selected entitlements table
            if (Object.keys(selectedEntitlements).length === 0) {
                selectedEntitlementsTable.innerHTML = '<p class="text-center">No entitlements selected.</p>';
                return;
            }
            
            let html = `
                <table class="entitlements-table">
                    <thead>
                        <tr>
                            <th class="key-column">Entitlement</th>
                            <th class="value-column">Value</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const [key, data] of Object.entries(selectedEntitlements)) {
                const valueDisplay = formatEntitlementValue(data.value);
                const sourceIcon = data.type === 'app' ? 
                    '<i class="fas fa-mobile-alt" title="From App"></i>' : 
                    '<i class="fas fa-file-signature" title="From Provision Profile"></i>';
                
                html += `
                    <tr>
                        <td class="key-column">${key}</td>
                        <td class="value-column">
                            <span class="entitlements-value">${valueDisplay}</span>
                        </td>
                        <td>${sourceIcon}</td>
                    </tr>
                `;
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            selectedEntitlementsTable.innerHTML = html;
        }
        
        // Create plist XML from entitlements object
        function createPlistXml(entitlements) {
            let xml = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
`;
            
            for (const [key, value] of Object.entries(entitlements)) {
                xml += `    <key>${key}</key>\n`;
                xml += `    ${formatPlistValue(value)}\n`;
            }
            
            xml += `</dict>
</plist>`;
            
            return xml;
        }
        
        // Format value for plist XML
        function formatPlistValue(value) {
            if (typeof value === 'boolean') {
                return value ? '<true/>' : '<false/>';
            } else if (typeof value === 'number') {
                if (Number.isInteger(value)) {
                    return `<integer>${value}</integer>`;
                } else {
                    return `<real>${value}</real>`;
                }
            } else if (typeof value === 'string') {
                return `<string>${escapeXml(value)}</string>`;
            } else if (Array.isArray(value)) {
                let arrayXml = '<array>\n';
                for (const item of value) {
                    arrayXml += `        ${formatPlistValue(item)}\n`;
                }
                arrayXml += '    </array>';
                return arrayXml;
            } else if (typeof value === 'object' && value !== null) {
                let dictXml = '<dict>\n';
                for (const [k, v] of Object.entries(value)) {
                    dictXml += `        <key>${escapeXml(k)}</key>\n`;
                    dictXml += `        ${formatPlistValue(v)}\n`;
                }
                dictXml += '    </dict>';
                return dictXml;
            } else {
                return `<string>${escapeXml(String(value))}</string>`;
            }
        }
        
        // Escape XML special characters
        function escapeXml(unsafe) {
            return unsafe.replace(/[<>&'"]/g, function(c) {
                switch (c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case '\'': return '&apos;';
                    case '"': return '&quot;';
                }
            });
        }
    });
</script>
{% endblock %}